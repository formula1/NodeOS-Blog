<!doctype html>
<html>
<head>
  <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" />
  <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css" />
  <link rel="stylesheet" href="http://node-os.com/css/default.css" />
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.13/angular.min.js"></script>
<script type="text/javascript" src="/api.min.js" ></script>
<style>
  #articles img{max-width:100%}
  #articles article .title img{width:100px}
</style>
</head>
<body>
  <header class="navbar navbar-default navbar-fixed-top" role="navigation">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://node-os.com">node-os</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse navbar-ex1-collapse">
      <ul class="nav navbar-nav">
        <li><a href="http://node-os.com/blog">Blog</a></li>
        <li><a href="http://npkg.org">npkg.org</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </header>
<!-- START: ISSUES ITEM TEMPLATE -->
<section ng-app="NodeOsBlog"  id="articles" class="section">
  <div class="container" ng-controller="ErrorListCtrl" >
  <article ng-repeat="(index, error) in errors" class="row">
    <div class="col-sm-8 col-sm-offset-2 {{error.class}}" >
      <header class="alert alert-danger" role="alert">
        <h3 class="title">{{error.name}}</h3>
        <p ng-mousedown="removeError(error)" > To remove this message, click here</p>
      </header>
      <div class="content" ng-bind-html="error.message | to_trusted"></div>
      <footer>
        Don't worry, it probably was not your fault... probably....
        <br/><br/>
        Even if it was,
        <a target="_blank" href="https://github.com/formula1/NodeOS-Blog/issues" >just submit an issue :)</a>
      </footer>
    </div>
  </article>
</div>
<div class="container" ng-controller="BlogListCtrl" >
  <article ng-repeat="item in blog" class="row">
    <div class="col-sm-8 col-sm-offset-2">
      <header class="{{item.state}}">
        <h3 class="title">
          <a href="article.html#{{item.number}}">
            {{item.title}}
          </a>
        </h3>
        <a href="{{item.html_url}}">View on Github</a>
      </header>
      <div class="content" ng-bind-html="item.bodyHTML | to_trusted"></div>
      <footer>
        <a href="http://node-os.com/blog/{{item.number}}" class="comments">
          There are {{item.comments}} comments.
        </a>
      </footer>
    </div>
  </article>
</div>
</section>
<!-- END: ISSUES ITEM TEMPLATE -->

<div class="section inverse trampstamp">
  <div class="row">
    <div class="col-xs-12"><img src="http://node-os.com/images/nodeos-update.png"></div>
  </div>
</div>

<footer>
  <div class="container" id="footer">
    <div class="row">
      <div class="col-sm-7">
        <h3 class="footer-title">Share</h3>
        <p>node-os is a work in progress.</p>
        <p>If you would like to support us, please share node-os via Twitter</p>
        <p class="pvl">
          <a href="https://twitter.com/TheNodeOS" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @TheNodeOS</a>
          <script type="text/javascript">
            (function(d,s,id){
              var js;
              fjs=d.getElementsByTagName(s)[0];
              p= /^http\:/.test(d.location)?'http':'https';
              if(!d.getElementById(id)){
                js=d.createElement(s);
                js.id=id;
                js.src=p+'://platform.twitter.com/widgets.js';
                fjs.parentNode.insertBefore(js,fjs);
              }
            })(document, 'script', 'twitter-wjs');
          </script>
          <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://node-os.com/blog/OS-flavors" data-text="NodeOS - The NodeJS Powered Operating System" data-via="TheNodeOS" data-size="large">Tweet</a>
        </p>

      </div>

    </div>
  </div>
</footer>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript" src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js" ></script>
<!-- START: BIND DATA TO VIEW -->
<script type="text/javascript">

  var NodeOsBlog = angular.module('NodeOsBlog', []);
  NodeOsBlog.filter('to_trusted', ['$sce', function($sce){
        return function(text) {
            return $sce.trustAsHtml(text);
        };
  }]);
  var errors = [];

function add403(){
  var topush = {
    class:"four-zero-three",
    name:"You've hit max data"
  };
  if(is_authed === 1){
    topush.message = "Apparently, people have been using our app too much..."+
    "<button onclick='login()'>Log in</button>";
  }else{
    topush.message = "If you'd like to continue, please "+
    "<button onclick='login()'>Log in</button>";
  }
  errors.push(topush);
}

NodeOsBlog.controller('ErrorListCtrl', function($scope){
  $scope.removeError = function(error){
    var l = errors.length;
    while(l--){
      if(errors[l] == error) return errors.splice(l,1);
    }
  };
  $scope.errors = errors;
  var oldwinerr = window.onerror;
  window.onerror = function ( message, filename, lineno, colno, error ){
    if ( error !== undefined && error.hasOwnProperty( "name" ) && error.name == "Magic"){
      errors.push({name:"Uncaught Error: "+error.name, message: message+"<pre>"+error.stack+"</pre>"});
    }
  };
});
/* */
function parseMarkdown(item,next){
  uriAsAuthority("https://api.github.com/markdown/raw",function(uri){
    jQuery.ajax({
      url:uri,
      type:'POST',
      headers: {
          'Content-Type': 'text/plain'
      },
      data:item.body
    }).done(function(data){
      item.bodyHTML = data;
    }).fail(function(response, type, title, config) {
      if(response.status === 403){
        add403();
      }else{
        errors.push({name:"Bad markdown call: "+response.status, message: data.message});
      }
      item.bodyHTML = "<pre>"+item.body+"</pre>";
    }).always(function(){
      next(item);
    });
  });
}

/*
var markdown = require("markdown").markdown;
function parseMarkdown(item,next){
  console.log("parsing");

  try{
    var t = jQuery("<div>"+markdown.toHTML(item.body)+"</div>");
    t.find("code").wrap("<pre></pre>");

    item.bodyHTML = t.html();
    console.log(item.bodyHTML);
  }catch(e){
    console.log(e);
    item.bodyHTML = "<pre>"+item.body+"</pre>";
  }
  setTimeout(next.bind(next,item),1);
}
/* */
function CookieStore(id){
  this.id = id;
  var cook = document.cookie.split(";");
  var current;
  var i;
  for(i=0;i<cook.length;i++){
    if(cook[i].indexOf("=") != -1){
      current = cook[i].split("=");
      if(current[0].replace(/s/, "") == id){
        this.cookie = JSON.parse(decodeURIComponent(current[1]));
        return;
      }
    }
  }
  this.cookie = {};
  this.save();
}

CookieStore.prototype.get = function(key){
  return this.cookie[key];
};
CookieStore.prototype.set = function(key, value){
  this.cookie[key] = value;
  this.save();
  return this;
};
CookieStore.prototype.delete = function(key){
  delete this.cookie[key];
  this.save();
  return this;
};

CookieStore.prototype.save = function(){
  document.cookie = this.id+"="+encodeURIComponent(JSON.stringify(this.cookie))+";";
};

//==========Auth Start===================


var auth = new CookieStore("auth");
var is_authed = -1;
var auth_queue = [];
var url = require("url");
var querystring = require("querystring");
var docuri = url.parse(window.location.href);
docuri.query = querystring.parse(docuri.query);
var config = {
  cid: "dafb27cb88db35267e75",
  yqluri: "store://gdDAnJkTXAuVgzAQ8wboA2"
};
if(docuri.query && docuri.query.code){
  if(docuri.query.state != auth.get("state")){
    errors.push(new Error("Improper State"));
  }else{
    getAccess(docuri.query.code);
  }
}else if(auth.get("access_token")){
  console.log(auth.get("access_token"));
  is_authed = 1;
}

function login(){
  var state = Date.now()+"_"+Math.random();
  auth.set("state", state);
  window.location.href = "https://github.com/login/oauth/authorize" +
    "?client_id="+config.cid +
    "&state="+state;
}
function getAccess(code){
  is_authed = 0;
  auth.delete("state");
  jQuery.get(compileYQL([
    "env \""+config.yqluri+"\"",
    "select * from github where CODE=\""+code+"\""
  ])).done(function(results){
    console.log("auth success");
    console.log(arguments);
    auth.set("access_token",results.query.results.OAuth.access_token);
    is_authed = 1;
    jQuery(".four-zero-three .content").text("You've authenticated!");
  }).fail(function(e){
    console.error(arguments);
    is_authed = -1;
    errors.push({
      class:"four-zero-three",
      name:"You've failed authorization",
      message: "You can always try again"
    });
  }).always(function(){
    console.log("always");
    while(auth_queue.length){
      uriAsAuthority.apply(void(0),auth_queue.pop());
    }
  });
}

function compileYQL(query){
  if(Array.isArray(query)){
    query = query.join(";");
  }
  if(typeof query != "string"){
    throw new Error("A yql query must be a string");
  }
  return "https://query.yahooapis.com/v1/public/yql?q=" +
    encodeURIComponent(query) +
    "&diagnostics=true&format=json";
}

function uriAsAuthority(uri,next){
  if(is_authed === -1) return next(uri);
  if(is_authed === 0) return auth_queue.push([uri,next]);
  uri = url.parse(uri);
  uri.query = querystring.parse(uri.query);
  uri.query.access_token = auth.get("access_token");
  uri.search = "?"+querystring.stringify(uri.query);
  next(url.format(uri));
}

function logout(){
  auth.delete("access_token");
  is_authed = -1;
}
NodeOsBlog.controller('BlogListCtrl', function ($scope, $http) {
  $scope.uriPath = "/NodeOS/NodeOS/issues";
  $scope.blog = [];
  $scope.last = void(0);
  $scope.uriAsAuthority = uriAsAuthority;
  $scope.parseMarkdown = parseMarkdown;
  $scope.loadMore = function(page){
    if($scope.last && $scope.last < page) return;
    var i=0;
    var l=-1;
    $scope.uriAsAuthority(
      'https://api.github.com/repos'+$scope.uriPath+'?labels=blog&sort=updated&page='+page,
      function(uri){
console.log("uri");
      $http.get(uri).success(function(data,status,headers) {
        console.log(headers);
        console.log(headers.link);
        if(!$scope.last) $scope.last =  headers.link?headers.link.split("=").pop():1;
        l = data.length;
        if(i === l) return; //No more
        var iterator = function(item){
          $scope.blog.push(item);
          $scope.$apply();
          i++;
          if(i === l) return;
          $scope.parseMarkdown(data[i],iterator);
        };
        $scope.parseMarkdown(data[0],iterator);
      }).error(function(data, status, headers, config) {
        if(status === 403){
          add403();
        }else{
          errors.push({name:"Bad issues list request: "+status, message: data.message});
        }
      });
    });
  };
  $scope.loadMore(1);
});
</script>
<!-- END: BIND DATA TO VIEW -->
</body>
</html>